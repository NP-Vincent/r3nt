<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>r3nt â€” Create Listing</title>

  <!-- Farcaster Mini App embed -->
  <meta name="fc:miniapp" content='{
    "version":"1",
    "imageUrl":"https://r3nt.sqmu.net/assets/icon.png",
    "button":{
      "title":"Open r3nt",
      "action":{
        "type":"launch_miniapp",
        "name":"r3nt",
        "url":"https://r3nt.sqmu.net/index.html",
        "splashImageUrl":"https://r3nt.sqmu.net/assets/splashscreen.png",
        "splashBackgroundColor":"#FFFFFF"
      }
    }
  }' />

  <style>
    :root { --fg:#0f172a; --bg:#ffffff; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; max-width: 460px; margin: 0 auto; padding: 16px 16px 40px; background: var(--bg); color: var(--fg); }
    h1 { font-size: 1.25rem; margin: 8px 0 12px; }
    .row { display: flex; gap: 10px; }
    label { display: block; font-size: .9rem; margin: 10px 0 6px; }
    input { width: 100%; padding: 10px 12px; border: 1px solid #d0d7de; border-radius: 8px; font-size: .95rem; }
    small.mono { font-family: ui-monospace, Menlo, monospace; color:#666; }
    button { width: 100%; padding: 12px 16px; border: 0; border-radius: 10px; font-weight: 700; cursor: pointer; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    #connect { background: #1f6feb; color: #fff; margin: 8px 0; }
    #create  { background: #10b981; color: #fff; margin: 8px 0; }
    .pill { display:inline-block; padding:2px 8px; background:#eef2ff; color:#3730a3; border-radius:999px; font-size:.8rem; }
    #status { min-height: 22px; margin-top: 10px; font-size: .95rem; color:#444; }
    .muted { color:#666; }
    .divider { height:1px; background:#eee; margin:14px 0; }
    nav { margin-bottom:16px; }
    nav a { margin-right:10px; color:#1f6feb; text-decoration:none; font-weight:600; }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
  </style>
</head>
<body>
  <nav>
    <a href="./index.html">Home</a>
    <a href="./tenant.html">Tenant</a>
    <a href="./landlord.html">Landlord</a>
    <a href="./admin.html">Admin</a>
  </nav>
  <h1>r3nt â€” Create Listing</h1>

  <div id="contextBar" class="muted">Startingâ€¦</div>
  <div id="feeInfo" class="muted">Platform info loadingâ€¦</div>

  <button id="connect" disabled>Connect Wallet</button>

  <div class="row">
    <label>Latitude
      <input id="lat" placeholder="25.2048" inputmode="decimal">
    </label>
    <label>Longitude
      <input id="lon" placeholder="55.2708" inputmode="decimal">
    </label>
  </div>
  <div class="muted"><small>We derive a GeoHash locally from these coordinates.</small></div>

  <label>Title (max 64 chars)
    <input id="title" maxlength="64" placeholder="Cozy studio near metro">
  </label>

  <label>Short description (max 140 chars)
    <input id="shortDesc" maxlength="140" placeholder="Furnished, walk to metro, fast Wiâ€‘Fi">
  </label>

  <div class="divider"></div>

  <div class="row">
    <label>Deposit (USDC)
      <input id="deposit" placeholder="100.00" inputmode="decimal">
    </label>
    <label>Property size (mÂ²)
      <input id="areaSqm" placeholder="85" inputmode="numeric">
    </label>
  </div>

  <label>Base daily rate (USDC)
    <input id="rateDaily" value="0" inputmode="decimal">
  </label>

  <div class="row">
    <label>Minimum notice (days)
      <input id="minNotice" value="1" inputmode="numeric">
    </label>
    <label>Booking window (days, 0 = unlimited)
      <input id="maxWindow" value="90" inputmode="numeric">
    </label>
  </div>

  <label>Metadata URI (optional)
    <input id="metadataUri" placeholder="https://...">
  </label>

  <button id="create" disabled>Create Listing</button>
  <div id="status"></div>

  <div class="divider"></div>
  <h2>Check Availability</h2>
  <label>Listing ID (starts at 1)
    <input id="availListing" inputmode="numeric" />
  </label>
  <div class="row">
    <label>Start
      <input type="date" id="availStart" />
    </label>
    <label>End
      <input type="date" id="availEnd" />
    </label>
  </div>
  <button id="checkAvail">Check</button>
  <div id="availResult" class="muted"></div>

  <script type="module">
    import { sdk } from 'https://esm.sh/@farcaster/miniapp-sdk';
    import { createPublicClient, http, encodeFunctionData, parseUnits, getAddress, stringToHex } from 'https://esm.sh/viem@2.9.32';
    import { arbitrum } from 'https://esm.sh/viem/chains';
    import { latLonToGeohash, isHex20or32, toBytes32FromCastHash } from './js/tools.js';
    import {
      CHAIN_ID,
      RPC_URL,
      PLATFORM_ADDRESS,
      PLATFORM_ABI,
      REGISTRY_ADDRESS,
      REGISTRY_ABI
    } from './js/config.js';

    const CHAIN_ID_HEX = '0x' + CHAIN_ID.toString(16);
    const USDC_DECIMALS = 6;

    const els = {
      contextBar:  document.getElementById('contextBar'),
      feeInfo:     document.getElementById('feeInfo'),
      connect:     document.getElementById('connect'),
      create:      document.getElementById('create'),
      status:      document.getElementById('status'),
      lat:         document.getElementById('lat'),
      lon:         document.getElementById('lon'),
      title:       document.getElementById('title'),
      shortDesc:   document.getElementById('shortDesc'),
      deposit:     document.getElementById('deposit'),
      areaSqm:     document.getElementById('areaSqm'),
      rateDaily:   document.getElementById('rateDaily'),
      minNotice:   document.getElementById('minNotice'),
      maxWindow:   document.getElementById('maxWindow'),
      metadataUri: document.getElementById('metadataUri'),
      availListing:document.getElementById('availListing'),
      availStart:  document.getElementById('availStart'),
      availEnd:    document.getElementById('availEnd'),
      checkAvail:  document.getElementById('checkAvail'),
      availResult: document.getElementById('availResult'),
    };
    const info = (t) => { els.status.textContent = t; };

    function formatUsdc(amount) {
      const n = typeof amount === 'bigint' ? amount : BigInt(amount || 0);
      const negative = n < 0n;
      const abs = negative ? -n : n;
      const units = abs / 1_000_000n;
      const fraction = abs % 1_000_000n;
      const fractionStr = fraction.toString().padStart(6, '0').replace(/0+$/, '');
      return `${negative ? '-' : ''}${units.toString()}${fractionStr ? '.' + fractionStr : ''}`;
    }

    function utf8BytesLen(str){ return new TextEncoder().encode(str).length; }
    function parseLatLon(latStr, lonStr) {
      const lat = Number(latStr), lon = Number(lonStr);
      if (!Number.isFinite(lat) || !Number.isFinite(lon)) throw new Error('Latitude/Longitude must be numbers.');
      if (lat<-90||lat>90||lon<-180||lon>180) throw new Error('Latitude/Longitude out of range.');
      return { lat, lon };
    }
    function parseDec6(s) {
      const v = String(s ?? '').trim();
      if (v === '') throw new Error('Missing numeric value.');
      if (!/^\d+(\.\d{1,6})?$/.test(v)) throw new Error('Use up to 6 decimals.');
      return parseUnits(v, USDC_DECIMALS);
    }
    function parseAreaSqmInput(input) {
      const v = String(input ?? '').trim();
      if (v === '') throw new Error('Square metre area is required.');
      if (!/^\d+$/.test(v)) throw new Error('Area must be a whole number.');
      const value = BigInt(v);
      if (value === 0n) throw new Error('Area must be greater than zero.');
      if (value > 4_294_967_295n) throw new Error('Area exceeds uint32 limit.');
      return value;
    }
    function parseDaysToSeconds(input, allowZero = false) {
      const raw = String(input ?? '').trim();
      if (raw === '') throw new Error('Enter number of days.');
      if (!/^\d+$/.test(raw)) throw new Error('Use whole number of days.');
      const days = BigInt(raw);
      if (!allowZero && days === 0n) throw new Error('Value must be greater than zero.');
      const secondsPerDay = 86_400n;
      return days * secondsPerDay;
    }
    function normalizeCastHash(h) {
      if (typeof h !== 'string') return null;
      const hex = h.startsWith('0x') ? h : ('0x' + h);
      if (!isHex20or32(hex)) return null;
      return toBytes32FromCastHash(hex);
    }
    function disableWhile(el, fn){
      return (async()=>{
        el.disabled = true;
        try { return await fn(); }
        finally { el.disabled = false; }
      })();
    }

    const pub = createPublicClient({ chain: arbitrum, transport: http(RPC_URL || 'https://arb1.arbitrum.io/rpc') });

    async function ensureArbitrum(p) {
      const id = await p.request({ method: 'eth_chainId' });
      if (id !== CHAIN_ID_HEX) {
        try {
          await p.request({ method:'wallet_switchEthereumChain', params:[{ chainId: CHAIN_ID_HEX }] });
        } catch {
          await p.request({
            method:'wallet_addEthereumChain',
            params:[{
              chainId: CHAIN_ID_HEX,
              chainName:'Arbitrum One',
              nativeCurrency:{ name:'Ether', symbol:'ETH', decimals:18 },
              rpcUrls:[RPC_URL || 'https://arb1.arbitrum.io/rpc'],
              blockExplorerUrls:['https://arbiscan.io']
            }]
          });
        }
      }
    }

    let fidBig;
    let provider;

    (async () => {
      try { await sdk.actions.ready(); } catch {}
      try {
        const { token } = await sdk.quickAuth.getToken();
        const [, payloadB64] = token.split('.');
        const payloadJson = JSON.parse(
          atob(payloadB64.replace(/-/g, '+').replace(/_/g, '/'))
        );
        fidBig = BigInt(payloadJson.sub);
        els.contextBar.textContent = `FID: ${fidBig.toString()} Â· Signed in`;
      } catch (e) {
        els.contextBar.textContent = 'QuickAuth failed. Open this inside a Farcaster client.';
        return;
      }

      try {
        const creationFee = await pub.readContract({ address: PLATFORM_ADDRESS, abi: PLATFORM_ABI, functionName: 'listingCreationFee' });
        const [tenantFeeBps, landlordFeeBps] = await pub.readContract({ address: PLATFORM_ADDRESS, abi: PLATFORM_ABI, functionName: 'fees' });
        const creationStr = formatUsdc(creationFee || 0n);
        const tenantPct = (Number(tenantFeeBps || 0n) / 100).toFixed(2);
        const landlordPct = (Number(landlordFeeBps || 0n) / 100).toFixed(2);
        els.feeInfo.textContent = `Creation fee: ${creationStr} USDC Â· Platform fees (tenant/landlord): ${tenantPct}% / ${landlordPct}%`;
      } catch {
        els.feeInfo.textContent = 'Unable to load platform fees.';
      }

      els.connect.disabled = false;
    })();

    els.connect.onclick = async () => {
      try {
        provider = await sdk.wallet.getEthereumProvider();
        await provider.request({ method:'eth_requestAccounts' });
        await ensureArbitrum(provider);
        els.connect.textContent = 'Wallet Connected';
        els.connect.style.background = '#10b981';
        els.create.disabled = false;
        info('Wallet ready.');
      } catch (e) {
        info(e?.message || 'Wallet connection failed.');
      }
    };

    els.create.onclick = () => disableWhile(els.create, async () => {
      try {
        if (fidBig === undefined) throw new Error('QuickAuth did not provide FID.');
        if (!provider) throw new Error('Connect your wallet first.');

        const [from] = await provider.request({ method:'eth_accounts' }) || [];
        if (!from) throw new Error('No wallet account connected.');
        await ensureArbitrum(provider);
        const landlordAddr = getAddress(from);

        const title = els.title.value.trim();
        const shortDesc = els.shortDesc.value.trim();
        if (!title) throw new Error('Title is required.');
        if (!shortDesc) throw new Error('Short description is required.');
        if (utf8BytesLen(title) > 64) throw new Error('Title exceeds 64 bytes.');
        if (utf8BytesLen(shortDesc) > 140) throw new Error('Short description exceeds 140 bytes.');

        const deposit    = parseDec6(els.deposit.value);
        const baseRate   = parseDec6(els.rateDaily.value || '0');
        const { lat, lon } = parseLatLon(els.lat.value, els.lon.value);
        const geohashStr = latLonToGeohash(lat, lon, 7);
        const geohashBytes = stringToHex(geohashStr, { size: 32 });
        const geolen = geohashStr.length;
        const areaSqm = parseAreaSqmInput(els.areaSqm.value);
        const minNoticeSec = parseDaysToSeconds(els.minNotice.value, false);
        const maxWindowSec = parseDaysToSeconds(els.maxWindow.value, true);
        const metadataUri = els.metadataUri.value.trim();

        info('Open composerâ€¦ Post your listing cast.');
        const qs = [
          'draft=1',
          `title=${encodeURIComponent(title)}`,
          `shortDesc=${encodeURIComponent(shortDesc)}`,
          `lat=${encodeURIComponent(String(lat))}`,
          `lon=${encodeURIComponent(String(lon))}`,
          `areaSqm=${encodeURIComponent(areaSqm.toString())}`
        ].join('&');
        const embedUrl = `https://r3nt.sqmu.net/index.html?${qs}`;
        const res = await sdk.actions.composeCast({
          text: `ðŸ  ${title}\n${shortDesc}\n\nView & book in r3nt â†“`,
          embeds: [ embedUrl ],
          close: false
        });
        if (res === undefined) {
          throw new Error('Composer invoked with close:true; no result returned.');
        }
        if (!res.cast) {
          throw new Error('Cast was not posted (user cancelled).');
        }
        const castHash = normalizeCastHash(res.cast.hash);
        if (!castHash) {
          throw new Error('Host returned an unexpected cast.hash format.');
        }

        info('Cast posted. Submitting on-chainâ€¦');
        const data = encodeFunctionData({
          abi: PLATFORM_ABI,
          functionName:'createListing',
          args: [
            landlordAddr,
            fidBig,
            castHash,
            geohashBytes,
            geolen,
            areaSqm,
            baseRate,
            deposit,
            minNoticeSec,
            maxWindowSec,
            metadataUri
          ]
        });
        const txHash = await provider.request({ method:'eth_sendTransaction', params:[{ from, to: PLATFORM_ADDRESS, data }] });
        info(`Listing tx sent: ${txHash}`);
      } catch (e) {
        info(`Error: ${e?.message || e}`);
      }
    });

    els.checkAvail.onclick = () => disableWhile(els.checkAvail, async () => {
      try {
        const idStr = els.availListing.value.trim();
        if (!/^\d+$/.test(idStr)) throw new Error('Enter listing id.');
        const listingId = BigInt(idStr);
        const start = els.availStart.value;
        const end = els.availEnd.value;
        if (!start || !end) throw new Error('Select dates.');
        const sTs = BigInt(Date.parse(start + 'T00:00:00Z') / 1000);
        const eTs = BigInt(Date.parse(end + 'T00:00:00Z') / 1000);
        if (eTs <= sTs) throw new Error('End before start');

        const listingAddr = await pub.readContract({ address: PLATFORM_ADDRESS, abi: PLATFORM_ABI, functionName: 'listingById', args:[listingId] });
        if (!listingAddr || listingAddr === '0x0000000000000000000000000000000000000000') {
          throw new Error('Listing not found.');
        }
        const free = await pub.readContract({ address: REGISTRY_ADDRESS, abi: REGISTRY_ABI, functionName:'isAvailable', args:[listingAddr, sTs, eTs] });
        els.availResult.textContent = free ? 'Available' : 'Booked';
      } catch (e) {
        els.availResult.textContent = e?.message || 'Error';
      }
    });
  </script>
</body>
</html>
