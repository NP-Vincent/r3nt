<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>r3nt — Create Listing</title>

  <!-- Farcaster Mini App embed -->
  <meta name="fc:miniapp" content='{
    "version":"1",
    "imageUrl":"https://r3nt.sqmu.net/assets/icon.png",
    "button":{
      "title":"Open r3nt",
      "action":{
        "type":"launch_miniapp",
        "name":"r3nt",
        "url":"https://r3nt.sqmu.net/index.html",
        "splashImageUrl":"https://r3nt.sqmu.net/assets/splashscreen.png",
        "splashBackgroundColor":"#FFFFFF"
      }
    }
  }' />

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; max-width: 460px; margin: 0 auto; padding: 16px 16px 40px; }
    h1 { font-size: 1.25rem; margin: 8px 0 12px; }
    .row { display: flex; gap: 10px; }
    label { display: block; font-size: .9rem; margin: 10px 0 6px; }
    input { width: 100%; padding: 10px 12px; border: 1px solid #d0d7de; border-radius: 8px; font-size: .95rem; }
    small.mono { font-family: ui-monospace, Menlo, monospace; color:#666; }
    button { width: 100%; padding: 12px 16px; border: 0; border-radius: 10px; font-weight: 700; cursor: pointer; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    #connect { background: #1f6feb; color: #fff; margin: 8px 0; }
    #create  { background: #10b981; color: #fff; margin: 8px 0; }
    .pill { display:inline-block; padding:2px 8px; background:#eef2ff; color:#3730a3; border-radius:999px; font-size:.8rem; }
    #status { min-height: 22px; margin-top: 10px; font-size: .95rem; color:#444; }
    .muted { color:#666; }
    .divider { height:1px; background:#eee; margin:14px 0; }
  </style>
</head>
<body>
  <h1>r3nt — Create Listing</h1>

  <div id="contextBar" class="muted">Loading Farcaster context…</div>
  <div id="feeInfo" class="muted">List fee: — USDC</div>

  <button id="connect">Connect Wallet</button>

  <label>Cast Hash (0x + 64 hex)
    <input id="castHash" placeholder="0x…" autocomplete="off" spellcheck="false">
  </label>

  <div class="row">
    <label>Latitude
      <input id="lat" placeholder="25.2048" inputmode="decimal">
    </label>
    <label>Longitude
      <input id="lon" placeholder="55.2708" inputmode="decimal">
    </label>
  </div>
  <div class="muted"><small>We derive a GeoHash locally from these coordinates.</small></div>

  <label>Title (max 64 chars)
    <input id="title" maxlength="64" placeholder="Cozy studio near metro">
  </label>

  <label>Short description (max 140 chars)
    <input id="shortDesc" maxlength="140" placeholder="Furnished, walk to metro, fast Wi-Fi">
  </label>

  <div class="divider"></div>

  <div class="row">
    <label>Deposit (USDC)
      <input id="deposit" placeholder="100.00" inputmode="decimal">
    </label>
  </div>

  <div class="row">
    <label>Daily (USDC)
      <input id="rateDaily"  value="0" inputmode="decimal">
    </label>
    <label>Weekly (USDC)
      <input id="rateWeekly" value="0" inputmode="decimal">
    </label>
    <label>Monthly (USDC)
      <input id="rateMonthly" value="0" inputmode="decimal">
    </label>
  </div>

  <div class="divider"></div>

  <div class="muted">
    <small class="mono">
      Signers are fixed: landlord + platform (hidden).
      <span id="signerMode" class="pill">Single-signer fallback</span>
    </small>
  </div>

  <button id="create" disabled>Create Listing</button>
  <div id="status"></div>

  <script type="module">
    import { sdk } from 'https://esm.sh/@farcaster/miniapp-sdk';
    import { createPublicClient, http, encodeFunctionData, parseUnits } from 'https://esm.sh/viem@2.9.32';
    import { arbitrum } from 'https://esm.sh/viem/chains';

    /* ------------------------- Config (edit as needed) ------------------------- */
    const ARBITRUM_HEX   = '0xa4b1';
    const R3NT_ADDRESS   = '0x18Af5B8fFA27B8300494Aa1a8c4F6AE4ee087029'; // r3nt proxy
    const USDC_ADDRESS   = '0xaf88d065e77c8cc2239327c5edb3a432268e5831'; // USDC.e (42161)
    const USDC_DECIMALS  = 6;

    // If you have ERC-7913 identity bytes, put them here:
    // Example: const APP_SIGNERS_BYTES = ['0x…landlord_identity_bytes', '0x…platform_identity_bytes'];
    const APP_SIGNERS_BYTES = [];
    const APP_THRESHOLD = (APP_SIGNERS_BYTES.length >= 2) ? 2n : 1n;

    /* ------------------------------ Inline ABIs ------------------------------- */
    const erc20Abi = [
      { type:'function', name:'approve',   stateMutability:'nonpayable',
        inputs:[{name:'spender',type:'address'},{name:'amount',type:'uint256'}],
        outputs:[{type:'bool'}] },
      { type:'function', name:'allowance', stateMutability:'view',
        inputs:[{name:'owner',type:'address'},{name:'spender',type:'address'}],
        outputs:[{type:'uint256'}] },
    ];

    const r3ntAbi = [
      { type:'function', name:'listFee', stateMutability:'view', inputs:[], outputs:[{type:'uint96'}] },
      { type:'function', name:'createListing', stateMutability:'nonpayable',
        inputs:[
          {name:'usdc',type:'address'},
          {name:'deposit',type:'uint96'},
          {name:'rateDaily',type:'uint96'},
          {name:'rateWeekly',type:'uint96'},
          {name:'rateMonthly',type:'uint96'},
          {name:'geohashStr',type:'string'},
          {name:'geolen',type:'uint8'},
          {name:'fid',type:'uint256'},
          {name:'castHash',type:'bytes32'},
          {name:'title',type:'string'},
          {name:'shortDesc',type:'string'},
          {name:'signers',type:'bytes[]'},
          {name:'threshold',type:'uint256'}
        ],
        outputs:[{type:'uint256'}]
      }
    ];

    /* ------------------------------- UI handles ------------------------------- */
    const els = {
      contextBar:  document.getElementById('contextBar'),
      feeInfo:     document.getElementById('feeInfo'),
      signerMode:  document.getElementById('signerMode'),
      connect:     document.getElementById('connect'),
      create:      document.getElementById('create'),
      status:      document.getElementById('status'),
      castHash:    document.getElementById('castHash'),
      lat:         document.getElementById('lat'),
      lon:         document.getElementById('lon'),
      title:       document.getElementById('title'),
      shortDesc:   document.getElementById('shortDesc'),
      deposit:     document.getElementById('deposit'),
      rateDaily:   document.getElementById('rateDaily'),
      rateWeekly:  document.getElementById('rateWeekly'),
      rateMonthly: document.getElementById('rateMonthly'),
    };
    const info = (t) => els.status.textContent = t;

    /* ------------------------------ Ready early ------------------------------- */
    (async () => {
      try { await sdk.actions.ready(); } catch {}
      // Safety retry in case host handshake is late
      setTimeout(()=>{ try { sdk.actions.ready(); } catch {} }, 500);
    })();

    /* ------------------------------- SDK context ------------------------------ */
    let viewerFid = null;
    let provider;

    const pub = createPublicClient({ chain: arbitrum, transport: http('https://arb1.arbitrum.io/rpc') });

    async function boot() {
      try {
        // Require Mini App host
        const inHost = await sdk.isInMiniApp().catch(()=>false);
        if (!inHost) throw new Error('Open this in a Farcaster client.');

        // Get FID from context
        viewerFid = sdk.context?.user?.fid ?? null;
        if (!viewerFid) throw new Error('Farcaster ID not available from host.');
        els.contextBar.textContent = `FID: ${viewerFid} · Ready`;

        // Show list fee
        const fee = await pub.readContract({ address: R3NT_ADDRESS, abi: r3ntAbi, functionName: 'listFee' });
        els.feeInfo.textContent = `List fee: ${(Number(fee)/1e6).toFixed(6)} USDC`;

        // Signer mode badge
        els.signerMode.textContent = (APP_THRESHOLD === 2n && APP_SIGNERS_BYTES.length >= 2)
          ? '2-of-2 multisig'
          : 'Single-signer fallback';

        // Enable create once wallet is connected
        els.create.disabled = true;
      } catch (e) {
        els.contextBar.textContent = `Cannot proceed: ${e?.message || e}`;
        els.create.disabled = true;
      }
    }

    /* ------------------------------ Wallet connect ---------------------------- */
    async function ensureArbitrum(p) {
      const id = await p.request({ method: 'eth_chainId' });
      if (id !== ARBITRUM_HEX) {
        try {
          await p.request({ method:'wallet_switchEthereumChain', params:[{ chainId: ARBITRUM_HEX }] });
        } catch {
          try {
            await p.request({
              method:'wallet_addEthereumChain',
              params:[{
                chainId: ARBITRUM_HEX, chainName:'Arbitrum One',
                nativeCurrency:{ name:'Ether', symbol:'ETH', decimals:18 },
                rpcUrls:['https://arb1.arbitrum.io/rpc'], blockExplorerUrls:['https://arbiscan.io']
              }]
            });
          } catch {}
        }
      }
    }

    els.connect.onclick = async () => {
      try {
        provider = await sdk.wallet.getEthereumProvider();
        await provider.request({ method:'eth_requestAccounts' });
        await ensureArbitrum(provider);
        els.connect.textContent = 'Wallet Connected';
        els.connect.style.background = '#10b981';
        els.create.disabled = false;
        info('Wallet ready.');
      } catch (e) {
        info(e?.message || 'Wallet connection failed.');
      }
    };

    /* ---------------------------- Helpers & checks ---------------------------- */
    const ALPH = '0123456789bcdefghjkmnpqrstuvwxyz';
    function encodeGeohash(lat, lon, precision = 7) {
      let idx=0, bit=0, even=true, gh='', latMin=-90,latMax=90, lonMin=-180,lonMax=180;
      while (gh.length < precision) {
        if (even) { const mid=(lonMin+lonMax)/2; if (lon>=mid){ idx=idx*2+1; lonMin=mid; } else { idx=idx*2; lonMax=mid; } }
        else {      const mid=(latMin+latMax)/2; if (lat>=mid){ idx=idx*2+1; latMin=mid; } else { idx=idx*2; latMax=mid; } }
        even=!even; if (++bit===5){ gh+=ALPH[idx]; bit=0; idx=0; }
      }
      return gh;
    }
    function parseLatLon(latStr, lonStr) {
      const lat = Number(latStr), lon = Number(lonStr);
      if (!Number.isFinite(lat) || !Number.isFinite(lon)) throw new Error('Latitude/Longitude must be numbers.');
      if (lat<-90||lat>90||lon<-180||lon>180) throw new Error('Latitude/Longitude out of range.');
      return { lat, lon };
    }
    function parseDec6(s) {
      const v = String(s ?? '').trim();
      if (v === '') throw new Error('Missing numeric value.');
      if (!/^\d+(\.\d{1,6})?$/.test(v)) throw new Error('Use up to 6 decimals.');
      return parseUnits(v, USDC_DECIMALS);
    }
    function isHex32(s){ return /^0x[0-9a-fA-F]{64}$/.test(s || ''); }

    /* ----------------------------- Create listing ----------------------------- */
    els.create.onclick = async () => {
      try {
        if (!viewerFid) throw new Error('Missing FID from host.');
        if (!provider) throw new Error('Connect your wallet first.');

        const [from] = await provider.request({ method:'eth_accounts' }) || [];
        if (!from) throw new Error('No wallet account connected.');
        await ensureArbitrum(provider);

        const castHash = els.castHash.value.trim();
        if (!isHex32(castHash)) throw new Error('Cast hash must be 0x + 64 hex characters.');

        const title = els.title.value.trim();
        const shortDesc = els.shortDesc.value.trim();
        if (!title) throw new Error('Title is required.');
        if (!shortDesc) throw new Error('Short description is required.');

        const deposit    = parseDec6(els.deposit.value);
        const rateDaily  = parseUnits(String(els.rateDaily.value||'0'),  USDC_DECIMALS);
        const rateWeekly = parseUnits(String(els.rateWeekly.value||'0'), USDC_DECIMALS);
        const rateMonthly= parseUnits(String(els.rateMonthly.value||'0'),USDC_DECIMALS);

        const { lat, lon } = parseLatLon(els.lat.value, els.lon.value);
        const geohashStr = encodeGeohash(lat, lon, 7);
        const geolen = geohashStr.length;
        if (geolen < 4 || geolen > 10) throw new Error('Internal: geohash length must be 4–10.');

        // 1) Ensure allowance for list fee
        info('Checking list fee & allowance…');
        const listFee = await pub.readContract({ address: R3NT_ADDRESS, abi: r3ntAbi, functionName: 'listFee' });
        const allowance = await pub.readContract({
          address: USDC_ADDRESS, abi: erc20Abi, functionName: 'allowance', args: [from, R3NT_ADDRESS]
        });
        if (allowance < listFee) {
          info('Approving USDC list fee…');
          const approveData = encodeFunctionData({ abi: erc20Abi, functionName:'approve', args:[R3NT_ADDRESS, listFee] });
          await provider.request({ method:'eth_sendTransaction', params:[{ from, to: USDC_ADDRESS, data: approveData }] });
        }

        // 2) Send createListing
        info('Submitting on-chain createListing…');
        const data = encodeFunctionData({
          abi: r3ntAbi, functionName:'createListing',
          args: [
            USDC_ADDRESS,
            deposit,
            rateDaily, rateWeekly, rateMonthly,
            geohashStr, geolen,
            BigInt(viewerFid),
            castHash,
            title, shortDesc,
            APP_SIGNERS_BYTES,
            APP_THRESHOLD
          ]
        });

        // Optional preflight gas estimate to surface issues early
        try { await provider.request({ method:'eth_estimateGas', params:[{ from, to:R3NT_ADDRESS, data }] }); } catch {}

        const txHash = await provider.request({ method:'eth_sendTransaction', params:[{ from, to:R3NT_ADDRESS, data }] });
        info(`Listing tx sent: ${txHash}`);
      } catch (e) {
        info(`Error: ${e?.message || e}`);
      }
    };

    // Kick off
    boot();
  </script>
</body>
</html>
