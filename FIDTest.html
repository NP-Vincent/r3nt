<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>r3nt — Create Listing</title>

  <!-- Must be present on EVERY route that runs in the client -->
  <meta name="fc:miniapp" content='{
    "version":"1",
    "imageUrl":"https://r3nt.sqmu.net/assets/icon.png",
    "button":{
      "title":"Open r3nt",
      "action":{
        "type":"launch_miniapp",
        "name":"r3nt",
        "url":"https://r3nt.sqmu.net/index.html",
        "splashImageUrl":"https://r3nt.sqmu.net/assets/splashscreen.png",
        "splashBackgroundColor":"#FFFFFF"
      }
    }
  }' />

  <!-- Recommended for QuickAuth -->
  <link rel="preconnect" href="https://auth.farcaster.xyz" />
  <script src="./js/dev-error-console.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; max-width: 460px; margin: 0 auto; padding: 20px; color:#0f172a; background:#ffffff; }
    nav { margin-bottom:16px; }
    nav a { margin-right:10px; color:#1f6feb; text-decoration:none; font-weight:600; }
    .version-badge { display:inline-block; margin-left:8px; padding:2px 6px; border-radius:8px; font-size:.65rem; letter-spacing:.08em; text-transform:uppercase; background:#e2e8f0; color:#475569; }
    #status { font-size:0.95rem; }
  </style>
</head>
<body>
  <nav>
    <a href="./index.html">Home</a>
    <a href="./tenant.html">Tenant</a>
    <a href="./landlord.html">Landlord</a>
    <a href="./investor.html">Investor</a>
    <a href="./agent.html">Agent</a>
    <a href="./admin.html">Admin</a>
    <a href="./platform.html">Platform</a>
    <span class="version-badge" data-version></span>
  </nav>
  <div id="status">Loading…</div>

  <script type="module">
    import { sdk } from "https://esm.sh/@farcaster/miniapp-sdk";
    import { APP_VERSION } from './js/config.js';

    const applyVersionBadge = () => {
      const badge = document.querySelector('[data-version]');
      if (badge) badge.textContent = `Build ${APP_VERSION}`;
    };

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', applyVersionBadge);
    } else {
      applyVersionBadge();
    }

    const status = document.getElementById('status');

    // 1) Tell the host we’re ready (splash can be hidden after this)
    try { await sdk.actions.ready(); } catch {}

    // 2) Ensure we are actually inside a Farcaster client
    if (!(await sdk.isInMiniApp().catch(()=>false))) {
      status.textContent = "Open this inside a Farcaster client.";
      throw new Error("Not in Mini App host");
    }

    // 3) Get a QuickAuth token — this is the *only* auth path here
    try {
      const { token } = await sdk.quickAuth.getToken(); // obtains or refreshes a session token
      // 4) Decode JWT locally to read the user’s FID (payload.sub)
      const [, payloadB64] = token.split('.');
      const payloadJson = JSON.parse(atob(payloadB64.replace(/-/g,'+').replace(/_/g,'/')));
      const fid = payloadJson.sub; // number

      status.textContent = `Signed in · FID ${fid}`;
      // Use `fid` for your contract args. No context reads needed.
    } catch (e) {
      status.textContent = "QuickAuth failed. Verify manifest domain + embed meta.";
      console.error(e);
    }
  </script>
</body>
